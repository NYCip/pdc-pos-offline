# Business Rules Document - PDC POS Offline

## Document Overview

**Module Name:** pdc_pos_offline
**Version:** 19.0.1.0.4
**Last Updated:** 2026-01-02
**Author:** POS.com Development Team

---

## 1. Business Domain Rules

### 1.1 Core Business Purpose

**Single Responsibility:** Enable POS LOGIN when Odoo server is offline.

This module addresses the critical business need for retail continuity during:
- Internet outages
- Server maintenance windows
- Network connectivity issues
- Power recovery scenarios

### 1.2 Business Workflow Rules

#### BW-001: Offline Authentication Flow
```
Online Mode → Server Unreachable → Offline Mode Activated → PIN Authentication → Session Restored
```

**Rules:**
1. PIN authentication ONLY activates when server is unreachable
2. Online authentication always uses Odoo's standard auth mechanism
3. Offline sessions are valid until server returns OR user logs out
4. No session timeout while offline (product decision)

#### BW-002: Session Persistence Rules
| Scenario | Behavior | Rationale |
|----------|----------|-----------|
| Browser close | Session preserved in IndexedDB | Business continuity |
| Browser crash | Session recoverable | Data protection |
| Power outage | Session recoverable | Retail resilience |
| Server returns | Automatic sync triggered | Data consistency |

#### BW-003: PIN Retry Policy
- **Client-side:** Unlimited retries (no lockout)
- **Server-side:** 5 attempts per 60 seconds per user
- **Rationale:** Prevent blocking legitimate staff while protecting against automated attacks

---

## 2. Data Integrity Rules

### 2.1 Credential Storage Rules

| Data Type | Storage Location | Format | Retention |
|-----------|-----------------|--------|-----------|
| PIN | Never stored | N/A | N/A |
| PIN Hash | IndexedDB + Server | Argon2id | Until changed |
| Session Token | IndexedDB | Encrypted | Until logout |
| User Profile | IndexedDB | JSON | 7 days |

### 2.2 Synchronization Rules

#### SYNC-001: Transaction Queue
- Offline transactions stored in IndexedDB `transactions` store
- Synced in FIFO order when connection restored
- Maximum 5 retry attempts per transaction
- Failed transactions logged to `sync_errors` store

#### SYNC-002: Data Freshness
| Data Type | Sync Frequency | Priority |
|-----------|---------------|----------|
| Session state | Immediate | Critical |
| User credentials | On login | High |
| Orders | 5 minutes | Medium |
| Configuration | On startup | Low |

---

## 3. User Role Rules

### 3.1 Permission Matrix

| Role | Set PIN | Offline Login | View Audit Logs | Manage Config |
|------|---------|---------------|-----------------|---------------|
| POS User | Own only | Yes | No | No |
| POS Manager | Team | Yes | Yes | No |
| System Admin | All | Yes | Yes | Yes |

### 3.2 Access Control Rules

#### ACL-001: PIN Management
- Users can only set their own PIN via user settings
- Managers can reset team member PINs
- System admins have full PIN management access

#### ACL-002: Offline Mode Access
- Only users with `point_of_sale.group_pos_user` can use offline mode
- PIN must be pre-configured while online
- No PIN = No offline access

---

## 4. Security Business Rules

### 4.1 Authentication Rules

#### SEC-001: PIN Requirements
- Exactly 4 digits (0-9)
- Cannot be common weak PINs (0000, 1234, 1111, etc.)
- Hashed with Argon2id (OWASP-recommended)

#### SEC-002: Rate Limiting
- 5 PIN attempts per 60 seconds per user
- Rate limit applies server-side only
- Client-side allows unlimited retries (by design)

#### SEC-003: Audit Trail
All authentication events logged with:
- User ID
- IP Address
- User Agent
- Timestamp
- Result (success/failure)
- Failure reason (server logs only)

### 4.2 Data Protection Rules

#### DPR-001: Sensitive Data Handling
- No plaintext credentials in storage
- No sensitive data in client-side logs
- Generic error messages to prevent enumeration
- Detailed logging server-side only

#### DPR-002: Session Security
- Session tokens generated by Odoo's secure mechanism
- No custom token generation
- Tokens stored in HttpOnly cookies where possible

---

## 5. Integration Rules

### 5.1 Odoo Core Integration

#### INT-001: POS Store Patching
- Use `patch()` from `@web/core/utils/patch`
- Override `setup()` for initialization
- Override `closePos()` for cleanup
- Never replace entire methods

#### INT-002: Service Dependencies
| Service | Usage | Required |
|---------|-------|----------|
| orm | Backend data operations | Yes |
| notification | User feedback | Yes |
| dialog | Login popup | Yes |
| bus_service | Sync events | Optional |

### 5.2 Module Dependencies

```python
'depends': ['point_of_sale', 'web']
```

**Hard Dependencies:**
- `point_of_sale`: POS infrastructure
- `web`: OWL components, services

**External Dependencies:**
- `argon2-cffi`: PIN hashing (Python)

---

## 6. Error Handling Rules

### 6.1 Error Classification

| Error Type | User Message | Log Level | Action |
|------------|--------------|-----------|--------|
| Auth failed | "Authentication failed" | WARNING | Retry allowed |
| Rate limited | "Authentication failed" | WARNING | Wait required |
| Network error | "Connection lost" | INFO | Auto-retry |
| IndexedDB error | "Storage unavailable" | ERROR | Fallback mode |

### 6.2 Recovery Procedures

#### ERR-001: Connection Loss During Transaction
1. Transaction saved to local queue
2. User notified of offline status
3. Retry on connection restore
4. Manual sync available via UI

#### ERR-002: IndexedDB Quota Exceeded
1. Warning displayed to user
2. Old synced transactions cleaned
3. If persists, require manual intervention

---

## 7. Compliance Rules

### 7.1 Data Retention

| Data Type | Retention Period | Deletion Trigger |
|-----------|-----------------|------------------|
| Sessions | 7 days | Automatic cleanup |
| Transactions (synced) | 30 days | Automatic cleanup |
| Sync errors | 7 days | Automatic cleanup |
| Audit logs | 90 days | Server policy |

### 7.2 Privacy Considerations

- No PII stored in IndexedDB beyond user ID and name
- PIN hashes are one-way (cannot be reversed)
- Session data minimal and functional only
- No tracking or analytics data collected

---

## 8. Business Metrics

### 8.1 Success Criteria

| Metric | Target | Measurement |
|--------|--------|-------------|
| Offline login time | < 2 seconds | Performance test |
| Session restore time | < 500ms | Performance test |
| Sync success rate | > 99% | Production monitoring |
| User satisfaction | > 4.5/5 | Survey |

### 8.2 SLA Commitments

- Offline mode available within 30 seconds of server failure
- Session persistence across all browser close scenarios
- Zero data loss for completed transactions
- Automatic sync within 5 minutes of connection restore

---

**Document Status:** Approved
**Review Cycle:** Quarterly
**Next Review:** 2026-04-01
